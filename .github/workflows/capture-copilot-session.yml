name: Capture Copilot Session on PR

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write
  contents: read
  issues: read

jobs:
  capture_session:
    runs-on: ubuntu-latest
    # Only run if PR is created from a branch named copilot/* or by Copilot
    if: startsWith(github.head_ref, 'copilot/') || contains(github.event.pull_request.body, 'Copilot')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm ci --omit=dev

      - name: Extract issue number from PR
        id: extract_issue
        run: |
          # Try to extract from PR body or branch name
          ISSUE_NUM=$(echo "${{ github.event.pull_request.body }}" | grep -oP '(?<=#)\d+(?=\s|$)' | head -1)
          if [ -z "$ISSUE_NUM" ]; then
            # Try from branch name (copilot/issue-49 -> 49)
            ISSUE_NUM=$(echo "${{ github.head_ref }}" | grep -oP '(?<=-)\d+$')
          fi
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "Issue number: $ISSUE_NUM"

      - name: Capture session
        if: steps.extract_issue.outputs.issue_number != ''
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use 'save' for new PRs, 'update' for existing PRs with new commits
          COMMAND="save"
          if [ "${{ github.event.action }}" == "synchronize" ]; then
            COMMAND="update"
          fi

          node scripts/session-manager.js $COMMAND \
            ${{ steps.extract_issue.outputs.issue_number }} \
            ${{ github.event.pull_request.number }}

      - name: Add session info to PR
        if: steps.extract_issue.outputs.issue_number != '' && github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            const sessionId = `copilot-issue-${{ steps.extract_issue.outputs.issue_number }}-pr-${{ github.event.pull_request.number }}`;
            const comment = `## ðŸ¤– Session Context Captured\n\nIf you request changes on this PR, use this session ID to restore context:\n\`${sessionId}\`\n\n### What This Means\n- Session state has been saved in \`.github/sessions/\`\n- When changes are requested, Copilot can restore this exact context\n- Allows seamless iteration on implementation feedback\n\n### Session Includes\n- Original issue context (#${{ steps.extract_issue.outputs.issue_number }})\n- Branch information (\`${{ github.head_ref }}\`)\n- Commit history and file changes\n- Implementation decisions\n\nFor review requests, mention the session ID or use the issue number to re-engage.`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Commit session to git
        if: steps.extract_issue.outputs.issue_number != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/sessions/
          git commit -m "session: capture implementation context for issue #${{ steps.extract_issue.outputs.issue_number }}" || echo "No changes to commit"
          git push origin ${{ github.head_ref }} || echo "Push failed or no changes"
